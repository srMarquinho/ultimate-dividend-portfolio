/* ultimate-dividend-portfolio - Version: 1.1.1 - https://github.com/srMarquinho/ultimate-dividend-portfolio - Marco Araujo */

function calcBoughtSold(){const[e,t,r,n,i,...o]=arguments;let s=filterData(e,null,null,...o);s=orderRangeByCol(s,t);let c={Bought:new Big(0),Sold:new Big(0)};const u={Bought:new Big(0),Sold:new Big(0)};return s.forEach((e,t)=>{const o=e[r-1],s=e[i-1],a=e[n-1];if(o&&s&&c[o]){if(n){if(u[o]=u[o].plus(a),!+u.Bought.minus(u.Sold))return void(c={Bought:new Big(0),Sold:new Big(0)})}c[o]=c[o].plus(s)}}),+c.Bought.minus(c.Sold)}function filterData(){let[e,t,r,...n]=arguments;const i=e.splice(0,1);return(t||r)&&(e=filterRowByDate(e,t,r)),n&&n.length&&n.filter(e=>e).forEach(t=>{e=filterRowByItem(e,t)}),i.concat(e)}function filterRowByItem(e,t){return e.reduce((e,r)=>(r.includes(t)&&e.push(r),e),[])}function filterRowByDate(e,t,r){return e.reduce((e,n)=>{if(!n[0])return e;const i=t&&n[0]>=t,o=r&&n[0]<=r;return i&&o?(e.push(n),e):(i&&!r&&e.push(n),o&&!t&&e.push(n),e)},[])}function sanitize(e){return e.replace("&amp;","&")}function tryValue(e,t){return e&&!isError(e)?e:t}function isError(e){return["#NULL!","#DIV/0!","#VALUE!","#REF!","#NAME?","#NUM!","#N/A","#ERROR!"].includes(e)}function orderRangeByCol(e,t){return e.filter(e=>e[t-1]).sort((e,r)=>e[t-1]===r[t-1]?0:e[0]<r[0]?-1:1)}function onOpen(){addUiItems(),createAllTriggers()}function addUiItems(){SpreadsheetApp.getUi().createMenu("PORTFOLIO").addItem("About","showWelcome").addItem("Refresh data","refreshResourceReq").addItem("Refresh portfolio calculations","refreshResourceCalc").addToUi()}function showWelcome(){const e=UrlFetchApp.fetch("https://raw.githubusercontent.com/srMarquinho/ultimate-dividend-portfolio/master/sidebar/welcome.html",{muteHttpExceptions:!0}).getContentText(),t=HtmlService.createHtmlOutput(e).setTitle("Ultimate Dividend Portfolio").setWidth(300);SpreadsheetApp.getUi().showSidebar(t)}function refreshResourceReq(){const e=SpreadsheetApp.getActiveSpreadsheet().getSheetByName("_resourceReq").getRange("A2"),t=e.getFormula();e.setFormula(null),SpreadsheetApp.flush(),e.setFormula(t)}function refreshResourceCalc(){const e=SpreadsheetApp.getActiveSpreadsheet().getSheetByName("_resourceCalc").getRange("A2"),t=e.getFormula();e.setFormula(null),SpreadsheetApp.flush(),e.setFormula(t)}function getResource(e){const t=getStores(e).QuoteSummaryStore;return[[getName(t),getExchange(t),getMarketPrice(t),getCurrency(t),getSector(t),getIndustry(t),getPERatio(t),getEPS(t),getDivYield(t),getDivShare(t),getExDividendDate(t),getDividendDate(t),getBeta5Year(t)]]}function getStores(e){try{const t="https://finance.yahoo.com/quote/"+e+"?millisToAvoidCache="+(new Date).getTime(),r=UrlFetchApp.fetch(t,{muteHttpExceptions:!0}).getContentText(),n=new RegExp(/root.App.main = \{.*\:\{.*\:.*\}\}/g).exec(r)[0].substring(16);return JSON.parse(n).context.dispatcher.stores}catch(e){return Logger.log(e)}}function defaultType(){return"Index/ETF"}function getName(e){return sanitize(e.price.longName)}function getExchange(e){return e.price.exchange}function getMarketPrice(e){return e.price.regularMarketPrice.raw}function getCurrency(e){const t=e.price.currency;return"GBp"===t?"GBX":t}function getSector(e){const t=e.summaryProfile;return t&&t.sector?t.sector:defaultType()}function getIndustry(e){const t=e.summaryProfile;return t&&t.industry?t.industry:defaultType()}function getPERatio(e){return e.summaryDetail&&e.summaryDetail.trailingPE&&e.summaryDetail.trailingPE.raw?e.summaryDetail.trailingPE.raw:"N/A"}function getEPS(e){return e.defaultKeyStatistics&&e.defaultKeyStatistics.trailingEps&&e.defaultKeyStatistics.trailingEps.raw?e.defaultKeyStatistics.trailingEps.raw:"N/A"}function getDivYield(e){return e.summaryDetail&&e.summaryDetail.dividendYield&&e.summaryDetail.dividendYield.raw?e.summaryDetail.dividendYield.raw:"N/A"}function getDivShare(e){return e.summaryDetail&&e.summaryDetail.dividendRate&&e.summaryDetail.dividendRate.raw?e.summaryDetail.dividendRate.raw:"N/A"}function getExDividendDate(e){if(!e.calendarEvents||!e.calendarEvents.exDividendDate||!e.calendarEvents.exDividendDate.raw)return"N/A";const t=e.calendarEvents.exDividendDate.raw;return new Date(1e3*t)}function getDividendDate(e){if(!e.calendarEvents||!e.calendarEvents.dividendDate||!e.calendarEvents.dividendDate.raw)return"N/A";const t=e.calendarEvents.dividendDate.raw;return new Date(1e3*t)}function getBeta5Year(e){return e.summaryDetail&&e.summaryDetail.beta&&e.summaryDetail.beta.raw?e.summaryDetail.beta.raw:"N/A"}function deleteAllTriggers(){ScriptApp.getProjectTriggers().forEach(e=>{ScriptApp.deleteTrigger(e)})}function createAllTriggers(){deleteAllTriggers(),createShowWelcome()}function createShowWelcome(){const e=SpreadsheetApp.getActive();ScriptApp.newTrigger("showWelcome").forSpreadsheet(e).onOpen().create()}!function(e){"use strict";var t,r=20,n=1,i=1e6,o=-7,s=21,c="[big.js] ",u=c+"Invalid ",a=u+"decimal places",l=u+"rounding mode",f={},d=void 0,h=/^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i;function g(e,t,r,n){var i=e.c,o=e.e+t+1;if(o<i.length){if(1===r)n=i[o]>=5;else if(2===r)n=i[o]>5||5==i[o]&&(n||o<0||i[o+1]!==d||1&i[o-1]);else if(3===r)n=n||!!i[0];else if(n=!1,0!==r)throw Error(l);if(o<1)i.length=1,n?(e.e=-t,i[0]=1):i[0]=e.e=0;else{if(i.length=o--,n)for(;++i[o]>9;)i[o]=0,o--||(++e.e,i.unshift(1));for(o=i.length;!i[--o];)i.pop()}}else if(r<0||r>3||r!==~~r)throw Error(l);return e}function p(e,t,r,n){var o,s,c=e.constructor,l=!e.c[0];if(r!==d){if(r!==~~r||r<(3==t)||r>i)throw Error(3==t?u+"precision":a);for(r=n-(e=new c(e)).e,e.c.length>++n&&g(e,r,c.RM),2==t&&(n=e.e+r+1);e.c.length<n;)e.c.push(0)}if(o=e.e,r=(s=e.c.join("")).length,2!=t&&(1==t||3==t&&n<=o||o<=c.NE||o>=c.PE))s=s.charAt(0)+(r>1?"."+s.slice(1):"")+(o<0?"e":"e+")+o;else if(o<0){for(;++o;)s="0"+s;s="0."+s}else if(o>0)if(++o>r)for(o-=r;o--;)s+="0";else o<r&&(s=s.slice(0,o)+"."+s.slice(o));else r>1&&(s=s.charAt(0)+"."+s.slice(1));return e.s<0&&(!l||4==t)?"-"+s:s}f.abs=function(){var e=new this.constructor(this);return e.s=1,e},f.cmp=function(e){var t,r=this,n=r.c,i=(e=new r.constructor(e)).c,o=r.s,s=e.s,c=r.e,u=e.e;if(!n[0]||!i[0])return n[0]?o:i[0]?-s:0;if(o!=s)return o;if(t=o<0,c!=u)return c>u^t?1:-1;for(s=(c=n.length)<(u=i.length)?c:u,o=-1;++o<s;)if(n[o]!=i[o])return n[o]>i[o]^t?1:-1;return c==u?0:c>u^t?1:-1},f.div=function(e){var t=this,r=t.constructor,n=t.c,o=(e=new r(e)).c,s=t.s==e.s?1:-1,c=r.DP;if(c!==~~c||c<0||c>i)throw Error(a);if(!o[0])throw Error("[big.js] Division by zero");if(!n[0])return new r(0*s);var u,l,f,h,p,m=o.slice(),w=u=o.length,v=n.length,D=n.slice(0,u),E=D.length,y=e,S=y.c=[],A=0,R=c+(y.e=t.e-e.e)+1;for(y.s=s,s=R<0?0:R,m.unshift(0);E++<u;)D.push(0);do{for(f=0;f<10;f++){if(u!=(E=D.length))h=u>E?1:-1;else for(p=-1,h=0;++p<u;)if(o[p]!=D[p]){h=o[p]>D[p]?1:-1;break}if(!(h<0))break;for(l=E==u?o:m;E;){if(D[--E]<l[E]){for(p=E;p&&!D[--p];)D[p]=9;--D[p],D[E]+=10}D[E]-=l[E]}for(;!D[0];)D.shift()}S[A++]=h?f:++f,D[0]&&h?D[E]=n[w]||0:D=[n[w]]}while((w++<v||D[0]!==d)&&s--);return S[0]||1==A||(S.shift(),y.e--),A>R&&g(y,c,r.RM,D[0]!==d),y},f.eq=function(e){return!this.cmp(e)},f.gt=function(e){return this.cmp(e)>0},f.gte=function(e){return this.cmp(e)>-1},f.lt=function(e){return this.cmp(e)<0},f.lte=function(e){return this.cmp(e)<1},f.minus=f.sub=function(e){var t,r,n,i,o=this,s=o.constructor,c=o.s,u=(e=new s(e)).s;if(c!=u)return e.s=-u,o.plus(e);var a=o.c.slice(),l=o.e,f=e.c,d=e.e;if(!a[0]||!f[0])return f[0]?(e.s=-u,e):new s(a[0]?o:0);if(c=l-d){for((i=c<0)?(c=-c,n=a):(d=l,n=f),n.reverse(),u=c;u--;)n.push(0);n.reverse()}else for(r=((i=a.length<f.length)?a:f).length,c=u=0;u<r;u++)if(a[u]!=f[u]){i=a[u]<f[u];break}if(i&&(n=a,a=f,f=n,e.s=-e.s),(u=(r=f.length)-(t=a.length))>0)for(;u--;)a[t++]=0;for(u=t;r>c;){if(a[--r]<f[r]){for(t=r;t&&!a[--t];)a[t]=9;--a[t],a[r]+=10}a[r]-=f[r]}for(;0===a[--u];)a.pop();for(;0===a[0];)a.shift(),--d;return a[0]||(e.s=1,a=[d=0]),e.c=a,e.e=d,e},f.mod=function(e){var t,r=this,n=r.constructor,i=r.s,o=(e=new n(e)).s;if(!e.c[0])throw Error("[big.js] Division by zero");return r.s=e.s=1,t=1==e.cmp(r),r.s=i,e.s=o,t?new n(r):(i=n.DP,o=n.RM,n.DP=n.RM=0,r=r.div(e),n.DP=i,n.RM=o,this.minus(r.times(e)))},f.plus=f.add=function(e){var t,r=this,n=r.constructor,i=r.s,o=(e=new n(e)).s;if(i!=o)return e.s=-o,r.minus(e);var s=r.e,c=r.c,u=e.e,a=e.c;if(!c[0]||!a[0])return a[0]?e:new n(c[0]?r:0*i);if(c=c.slice(),i=s-u){for(i>0?(u=s,t=a):(i=-i,t=c),t.reverse();i--;)t.push(0);t.reverse()}for(c.length-a.length<0&&(t=a,a=c,c=t),i=a.length,o=0;i;c[i]%=10)o=(c[--i]=c[i]+a[i]+o)/10|0;for(o&&(c.unshift(o),++u),i=c.length;0===c[--i];)c.pop();return e.c=c,e.e=u,e},f.pow=function(e){var t=this,r=new t.constructor(1),n=r,i=e<0;if(e!==~~e||e<-1e6||e>1e6)throw Error(u+"exponent");for(i&&(e=-e);1&e&&(n=n.times(t)),e>>=1;)t=t.times(t);return i?r.div(n):n},f.round=function(e,t){var r=this.constructor;if(e===d)e=0;else if(e!==~~e||e<-i||e>i)throw Error(a);return g(new r(this),e,t===d?r.RM:t)},f.sqrt=function(){var e,t,r,n=this,i=n.constructor,o=n.s,s=n.e,u=new i(.5);if(!n.c[0])return new i(n);if(o<0)throw Error(c+"No square root");0===(o=Math.sqrt(n+""))||o===1/0?((t=n.c.join("")).length+s&1||(t+="0"),o=Math.sqrt(t),s=((s+1)/2|0)-(s<0||1&s),e=new i((o==1/0?"1e":(o=o.toExponential()).slice(0,o.indexOf("e")+1))+s)):e=new i(o),s=e.e+(i.DP+=4);do{r=e,e=u.times(r.plus(n.div(r)))}while(r.c.slice(0,s).join("")!==e.c.slice(0,s).join(""));return g(e,i.DP-=4,i.RM)},f.times=f.mul=function(e){var t,r=this,n=r.constructor,i=r.c,o=(e=new n(e)).c,s=i.length,c=o.length,u=r.e,a=e.e;if(e.s=r.s==e.s?1:-1,!i[0]||!o[0])return new n(0*e.s);for(e.e=u+a,s<c&&(t=i,i=o,o=t,a=s,s=c,c=a),t=new Array(a=s+c);a--;)t[a]=0;for(u=c;u--;){for(c=0,a=s+u;a>u;)c=t[a]+o[u]*i[a-u-1]+c,t[a--]=c%10,c=c/10|0;t[a]=c}for(c?++e.e:t.shift(),u=t.length;!t[--u];)t.pop();return e.c=t,e},f.toExponential=function(e){return p(this,1,e,e)},f.toFixed=function(e){return p(this,2,e,this.e+e)},f.toPrecision=function(e){return p(this,3,e,e-1)},f.toString=function(){return p(this)},f.valueOf=f.toJSON=function(){return p(this,4)},(t=function e(){function t(r){var n=this;if(!(n instanceof t))return r===d?e():new t(r);r instanceof t?(n.s=r.s,n.e=r.e,n.c=r.c.slice()):function(e,t){var r,n,i;if(0===t&&1/t<0)t="-0";else if(!h.test(t+=""))throw Error(u+"number");for(e.s="-"==t.charAt(0)?(t=t.slice(1),-1):1,(r=t.indexOf("."))>-1&&(t=t.replace(".","")),(n=t.search(/e/i))>0?(r<0&&(r=n),r+=+t.slice(n+1),t=t.substring(0,n)):r<0&&(r=t.length),i=t.length,n=0;n<i&&"0"==t.charAt(n);)++n;if(n==i)e.c=[e.e=0];else{for(;i>0&&"0"==t.charAt(--i););for(e.e=r-n-1,e.c=[],r=0;n<=i;)e.c[r++]=+t.charAt(n++)}}(n,r),n.constructor=t}return t.prototype=f,t.DP=r,t.RM=n,t.NE=o,t.PE=s,t.version="5.2.2",t}()).default=t.Big=t,"function"==typeof define&&define.amd?define(function(){return t}):"undefined"!=typeof module&&module.exports?module.exports=t:e.Big=t}(this);